# 成语故事短视频生成系统 - DeepSeek调用流程图

## ASCII流程图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           成语故事短视频生成系统 - DeepSeek调用流程                │
└─────────────────────────────────────────────────────────────────────────────────┘

用户输入成语
     │
     ▼
┌─────────────┐
│ 初始化系统   │
└─────────────┘
     │
     ▼
┌─────────────┐    是    ┌─────────────┐
│ 检查缓存     │ ──────→ │ 返回缓存故事 │
└─────────────┘         └─────────────┘
     │
     ▼ 否
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           构建DeepSeek提示词                                    │
│                                                                                 │
│ 请为成语"{idiom}"创作一个适合3-8岁儿童阅读的故事，要求：                        │
│ • 字数控制在300字以内                                                           │
│ • 包含丰富的场景描述，便于后续生成插画                                          │
│ • 语言生动有趣，符合儿童认知水平                                                │
│ • 故事要有明确的开始、发展和结尾                                                │
│ • 每个场景都要有详细的视觉描述                                                  │
│ • 故事要有教育意义，传递正面价值观                                              │
└─────────────────────────────────────────────────────────────────────────────────┘
     │
     ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           调用DeepSeek API                                      │
│                                                                                 │
│ POST https://api.deepseek.com/v1/chat/completions                              │
│                                                                                 │
│ Headers:                                                                        │
│ • Authorization: Bearer {API_KEY}                                              │
│ • Content-Type: application/json                                               │
│                                                                                 │
│ Body:                                                                           │
│ {                                                                               │
│   "model": "deepseek-chat",                                                    │
│   "messages": [{"role": "user", "content": "提示词"}],                         │
│   "temperature": 0.8,                                                          │
│   "max_tokens": 1000,                                                          │
│   "top_p": 0.9,                                                                │
│   "frequency_penalty": 0.1,                                                    │
│   "presence_penalty": 0.1                                                      │
│ }                                                                               │
└─────────────────────────────────────────────────────────────────────────────────┘
     │
     ▼
┌─────────────┐
│ 解析响应     │
└─────────────┘
     │
     ▼
┌─────────────┐    通过   ┌─────────────┐
│ 质量验证     │ ──────→ │ 保存到缓存   │
└─────────────┘         └─────────────┘
     │
     ▼ 失败
┌─────────────┐    是    ┌─────────────┐
│ 重试次数<3?  │ ──────→ │ 等待退避时间 │
└─────────────┘         └─────────────┘
     │                      │
     ▼ 否                   │
┌─────────────┐             │
│ 抛出错误     │             │
└─────────────┘             │
                            │
                            ▼
                    ┌─────────────┐
                    │ 重新调用API  │
                    └─────────────┘
                            │
                            ▼
                    ┌─────────────┐
                    │ 返回故事文本 │
                    └─────────────┘
                            │
                            ▼
                    ┌─────────────────────────────────────────────────────────────┐
                    │                        后续处理流程                          │
                    │                                                             │
                    │ 故事文本 → 场景提取 → 图像生成 → 音频生成 → 视频合成 → 输出 │
                    └─────────────────────────────────────────────────────────────┘
```

## 详细调用时序图

```
时间轴: 0s    5s    10s   15s   20s   25s   30s   35s   40s   45s   50s
        │     │     │     │     │     │     │     │     │     │     │
用户    │输入成语
        │
系统    │     │检查缓存
        │     │
        │     │     │构建提示词
        │     │     │
        │     │     │     │调用DeepSeek API
        │     │     │     │
        │     │     │     │     │解析响应
        │     │     │     │     │
        │     │     │     │     │     │质量验证
        │     │     │     │     │     │
        │     │     │     │     │     │     │保存缓存
        │     │     │     │     │     │     │
        │     │     │     │     │     │     │     │返回故事
        │     │     │     │     │     │     │     │
        │     │     │     │     │     │     │     │     │场景提取
        │     │     │     │     │     │     │     │     │
        │     │     │     │     │     │     │     │     │     │图像生成
        │     │     │     │     │     │     │     │     │     │
        │     │     │     │     │     │     │     │     │     │     │音频生成
        │     │     │     │     │     │     │     │     │     │     │
        │     │     │     │     │     │     │     │     │     │     │     │视频合成
        │     │     │     │     │     │     │     │     │     │     │     │
        │     │     │     │     │     │     │     │     │     │     │     │     │输出结果
```

## 错误处理流程图

```
API调用失败
     │
     ▼
┌─────────────┐
│ 记录错误类型 │
└─────────────┘
     │
     ▼
┌─────────────┐
│ 检查重试次数 │
└─────────────┘
     │
     ▼
┌─────────────┐    是    ┌─────────────┐
│ 次数<3?     │ ──────→ │ 计算退避时间 │
└─────────────┘         └─────────────┘
     │                      │
     ▼ 否                   │
┌─────────────┐             │
│ 抛出最终错误 │             │
└─────────────┘             │
                            │
                            ▼
                    ┌─────────────┐
                    │ 等待退避时间 │
                    └─────────────┘
                            │
                            ▼
                    ┌─────────────┐
                    │ 重新调用API  │
                    └─────────────┘
```

## 缓存机制图

```
请求故事
     │
     ▼
┌─────────────┐
│ 生成缓存键   │
│ story_{idiom}│
│ _{hash}     │
└─────────────┘
     │
     ▼
┌─────────────┐    存在   ┌─────────────┐
│ 检查缓存文件 │ ──────→ │ 读取缓存内容 │
└─────────────┘         └─────────────┘
     │                      │
     ▼ 不存在               │
┌─────────────┐             │
│ 调用DeepSeek│             │
└─────────────┘             │
     │                      │
     ▼                      │
┌─────────────┐             │
│ 生成新故事   │             │
└─────────────┘             │
     │                      │
     ▼                      │
┌─────────────┐             │
│ 保存到缓存   │             │
└─────────────┘             │
     │                      │
     ▼                      │
┌─────────────┐             │
│ 返回新故事   │             │
└─────────────┘             │
     │                      │
     └──────────────────────┘
                            │
                            ▼
                    ┌─────────────┐
                    │ 返回故事文本 │
                    └─────────────┘
```

## 质量验证标准

```
故事文本
     │
     ▼
┌─────────────┐    通过   ┌─────────────┐
│ 长度检查     │ ──────→ │ 内容检查     │
│ ≤500字      │         │ 包含故事元素 │
└─────────────┘         └─────────────┘
     │                      │
     ▼ 失败                 ▼ 通过
┌─────────────┐         ┌─────────────┐
│ 验证失败     │         │ 结构检查     │
└─────────────┘         │ 开始发展结尾 │
                        └─────────────┘
                            │
                            ▼ 通过
                    ┌─────────────┐
                    │ 语言检查     │
                    │ 儿童友好     │
                    └─────────────┘
                            │
                            ▼ 通过
                    ┌─────────────┐
                    │ 验证通过     │
                    └─────────────┘
```

## 技术参数配置

```
DeepSeek API配置:
├── 模型: deepseek-chat
├── 温度: 0.8 (创造性)
├── 最大Token: 1000
├── Top-p: 0.9 (核采样)
├── 频率惩罚: 0.1
├── 存在惩罚: 0.1
└── 超时时间: 30秒

重试机制:
├── 最大重试: 3次
├── 退避策略: 指数退避
├── 退避公式: 2^attempt秒
└── 错误类型: 网络/解析/验证

缓存策略:
├── 缓存键: story_{idiom}_{hash}
├── 存储位置: ./cache/
├── 文件格式: .pkl
└── 生命周期: 永久存储
```


